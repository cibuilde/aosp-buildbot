
name: AOSP Build
on:
  push:
    branch:
    - main
env:
  branch: 'android-12.0.0_r1'
jobs:
  build_step0:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - uses: actions/setup-python@v4
      with:
        python-version: "2.7"
    - name: Download get_clang_version.py
      run: |
        curl 'https://android.googlesource.com/platform/build/soong/+/refs/heads/master/scripts/get_clang_version.py?format=TEXT' | base64 -d > $GITHUB_WORKSPACE/get_clang_version.py
        mkdir -p aosp

    - name: Restore Cache build/make
      id: build_make
      uses: actions/cache@v3
      with:
        path: aosp/build/make
        key: build_make@${{ env.branch }}
        restore-keys: build_make@${{ env.branch }}
    - name: Clone project build/make
      if: steps.build_make.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform build
        mv build make && mkdir build && mv make build/
        sed -i 's/^PRODUCT_EXTRA_VNDK_VERSIONS/#PRODUCT_EXTRA_VNDK_VERSIONS/g' build/make/target/product/gsi_release.mk

    - name: Restore Cache bionic
      id: bionic
      uses: actions/cache@v3
      with:
        path: aosp/bionic
        key: bionic@${{ env.branch }}
        restore-keys: bionic@${{ env.branch }}
    - name: Clone project bionic
      if: steps.bionic.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform bionic

    - name: Restore Cache build/blueprint
      id: build_blueprint
      uses: actions/cache@v3
      with:
        path: aosp/build/blueprint
        key: build_blueprint@${{ env.branch }}
        restore-keys: build_blueprint@${{ env.branch }}
    - name: Clone project build/blueprint
      if: steps.build_blueprint.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform build/blueprint

    - name: Restore Cache build/soong
      id: build_soong
      uses: actions/cache@v3
      with:
        path: aosp/build/soong
        key: build_soong@${{ env.branch }}
        restore-keys: build_soong@${{ env.branch }}
    - name: Clone project build/soong
      if: steps.build_soong.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform build/soong

    - name: Restore Cache external/arm-optimized-routines
      id: external_arm-optimized-routines
      uses: actions/cache@v3
      with:
        path: aosp/external/arm-optimized-routines
        key: external_arm-optimized-routines@${{ env.branch }}
        restore-keys: external_arm-optimized-routines@${{ env.branch }}
    - name: Clone project external/arm-optimized-routines
      if: steps.external_arm-optimized-routines.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/arm-optimized-routines

    - name: Restore Cache external/crosvm
      id: external_crosvm
      uses: actions/cache@v3
      with:
        path: aosp/external/crosvm
        key: external_crosvm@${{ env.branch }}
        restore-keys: external_crosvm@${{ env.branch }}
    - name: Clone project external/crosvm
      if: steps.external_crosvm.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/crosvm

    - name: Restore Cache external/golang-protobuf
      id: external_golang-protobuf
      uses: actions/cache@v3
      with:
        path: aosp/external/golang-protobuf
        key: external_golang-protobuf@${{ env.branch }}
        restore-keys: external_golang-protobuf@${{ env.branch }}
    - name: Clone project external/golang-protobuf
      if: steps.external_golang-protobuf.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/golang-protobuf

    - name: Restore Cache external/gwp_asan
      id: external_gwp_asan
      uses: actions/cache@v3
      with:
        path: aosp/external/gwp_asan
        key: external_gwp_asan@${{ env.branch }}
        restore-keys: external_gwp_asan@${{ env.branch }}
    - name: Clone project external/gwp_asan
      if: steps.external_gwp_asan.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/gwp_asan

    - name: Restore Cache external/rust/crates/bytes
      id: external_rust_crates_bytes
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/bytes
        key: external_rust_crates_bytes@${{ env.branch }}
        restore-keys: external_rust_crates_bytes@${{ env.branch }}
    - name: Clone project external/rust/crates/bytes
      if: steps.external_rust_crates_bytes.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/bytes

    - name: Restore Cache external/rust/crates/downcast-rs
      id: external_rust_crates_downcast-rs
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/downcast-rs
        key: external_rust_crates_downcast-rs@${{ env.branch }}
        restore-keys: external_rust_crates_downcast-rs@${{ env.branch }}
    - name: Clone project external/rust/crates/downcast-rs
      if: steps.external_rust_crates_downcast-rs.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/downcast-rs

    - name: Restore Cache external/rust/crates/either
      id: external_rust_crates_either
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/either
        key: external_rust_crates_either@${{ env.branch }}
        restore-keys: external_rust_crates_either@${{ env.branch }}
    - name: Clone project external/rust/crates/either
      if: steps.external_rust_crates_either.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/either

    - name: Restore Cache external/rust/crates/fallible-iterator
      id: external_rust_crates_fallible-iterator
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/fallible-iterator
        key: external_rust_crates_fallible-iterator@${{ env.branch }}
        restore-keys: external_rust_crates_fallible-iterator@${{ env.branch }}
    - name: Clone project external/rust/crates/fallible-iterator
      if: steps.external_rust_crates_fallible-iterator.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/fallible-iterator

    - name: Restore Cache external/rust/crates/fallible-streaming-iterator
      id: external_rust_crates_fallible-streaming-iterator
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/fallible-streaming-iterator
        key: external_rust_crates_fallible-streaming-iterator@${{ env.branch }}
        restore-keys: external_rust_crates_fallible-streaming-iterator@${{ env.branch }}
    - name: Clone project external/rust/crates/fallible-streaming-iterator
      if: steps.external_rust_crates_fallible-streaming-iterator.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/fallible-streaming-iterator

    - name: Restore Cache external/rust/crates/glob
      id: external_rust_crates_glob
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/glob
        key: external_rust_crates_glob@${{ env.branch }}
        restore-keys: external_rust_crates_glob@${{ env.branch }}
    - name: Clone project external/rust/crates/glob
      if: steps.external_rust_crates_glob.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/glob

    - name: Restore Cache external/rust/crates/lazycell
      id: external_rust_crates_lazycell
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/lazycell
        key: external_rust_crates_lazycell@${{ env.branch }}
        restore-keys: external_rust_crates_lazycell@${{ env.branch }}
    - name: Clone project external/rust/crates/lazycell
      if: steps.external_rust_crates_lazycell.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/lazycell

    - name: Restore Cache external/rust/crates/paste
      id: external_rust_crates_paste
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/paste
        key: external_rust_crates_paste@${{ env.branch }}
        restore-keys: external_rust_crates_paste@${{ env.branch }}
    - name: Clone project external/rust/crates/paste
      if: steps.external_rust_crates_paste.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/paste

    - name: Restore Cache external/rust/crates/peeking_take_while
      id: external_rust_crates_peeking_take_while
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/peeking_take_while
        key: external_rust_crates_peeking_take_while@${{ env.branch }}
        restore-keys: external_rust_crates_peeking_take_while@${{ env.branch }}
    - name: Clone project external/rust/crates/peeking_take_while
      if: steps.external_rust_crates_peeking_take_while.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/peeking_take_while

    - name: Restore Cache external/rust/crates/proc-macro-hack
      id: external_rust_crates_proc-macro-hack
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/proc-macro-hack
        key: external_rust_crates_proc-macro-hack@${{ env.branch }}
        restore-keys: external_rust_crates_proc-macro-hack@${{ env.branch }}
    - name: Clone project external/rust/crates/proc-macro-hack
      if: steps.external_rust_crates_proc-macro-hack.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/proc-macro-hack

    - name: Restore Cache external/rust/crates/regex-syntax
      id: external_rust_crates_regex-syntax
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/regex-syntax
        key: external_rust_crates_regex-syntax@${{ env.branch }}
        restore-keys: external_rust_crates_regex-syntax@${{ env.branch }}
    - name: Clone project external/rust/crates/regex-syntax
      if: steps.external_rust_crates_regex-syntax.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/regex-syntax

    - name: Restore Cache external/rust/crates/rustc-hash
      id: external_rust_crates_rustc-hash
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/rustc-hash
        key: external_rust_crates_rustc-hash@${{ env.branch }}
        restore-keys: external_rust_crates_rustc-hash@${{ env.branch }}
    - name: Clone project external/rust/crates/rustc-hash
      if: steps.external_rust_crates_rustc-hash.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/rustc-hash

    - name: Restore Cache external/rust/crates/scopeguard
      id: external_rust_crates_scopeguard
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/scopeguard
        key: external_rust_crates_scopeguard@${{ env.branch }}
        restore-keys: external_rust_crates_scopeguard@${{ env.branch }}
    - name: Clone project external/rust/crates/scopeguard
      if: steps.external_rust_crates_scopeguard.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/scopeguard

    - name: Restore Cache external/rust/crates/shlex
      id: external_rust_crates_shlex
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/shlex
        key: external_rust_crates_shlex@${{ env.branch }}
        restore-keys: external_rust_crates_shlex@${{ env.branch }}
    - name: Clone project external/rust/crates/shlex
      if: steps.external_rust_crates_shlex.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/shlex

    - name: Restore Cache external/rust/crates/termcolor
      id: external_rust_crates_termcolor
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/termcolor
        key: external_rust_crates_termcolor@${{ env.branch }}
        restore-keys: external_rust_crates_termcolor@${{ env.branch }}
    - name: Clone project external/rust/crates/termcolor
      if: steps.external_rust_crates_termcolor.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/termcolor

    - name: Restore Cache external/rust/crates/unicode-segmentation
      id: external_rust_crates_unicode-segmentation
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/unicode-segmentation
        key: external_rust_crates_unicode-segmentation@${{ env.branch }}
        restore-keys: external_rust_crates_unicode-segmentation@${{ env.branch }}
    - name: Clone project external/rust/crates/unicode-segmentation
      if: steps.external_rust_crates_unicode-segmentation.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/unicode-segmentation

    - name: Restore Cache external/rust/crates/unicode-width
      id: external_rust_crates_unicode-width
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/unicode-width
        key: external_rust_crates_unicode-width@${{ env.branch }}
        restore-keys: external_rust_crates_unicode-width@${{ env.branch }}
    - name: Clone project external/rust/crates/unicode-width
      if: steps.external_rust_crates_unicode-width.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/unicode-width

    - name: Restore Cache external/rust/crates/unicode-xid
      id: external_rust_crates_unicode-xid
      uses: actions/cache@v3
      with:
        path: aosp/external/rust/crates/unicode-xid
        key: external_rust_crates_unicode-xid@${{ env.branch }}
        restore-keys: external_rust_crates_unicode-xid@${{ env.branch }}
    - name: Clone project external/rust/crates/unicode-xid
      if: steps.external_rust_crates_unicode-xid.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/rust/crates/unicode-xid

    - name: Restore Cache external/scudo
      id: external_scudo
      uses: actions/cache@v3
      with:
        path: aosp/external/scudo
        key: external_scudo@${{ env.branch }}
        restore-keys: external_scudo@${{ env.branch }}
    - name: Clone project external/scudo
      if: steps.external_scudo.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/scudo

    - name: Restore Cache external/starlark-go
      id: external_starlark-go
      uses: actions/cache@v3
      with:
        path: aosp/external/starlark-go
        key: external_starlark-go@${{ env.branch }}
        restore-keys: external_starlark-go@${{ env.branch }}
    - name: Clone project external/starlark-go
      if: steps.external_starlark-go.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform external/starlark-go

    - name: Restore Cache frameworks/rs
      id: frameworks_rs
      uses: actions/cache@v3
      with:
        path: aosp/frameworks/rs
        key: frameworks_rs@${{ env.branch }}
        restore-keys: frameworks_rs@${{ env.branch }}
    - name: Clone project frameworks/rs
      if: steps.frameworks_rs.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform frameworks/rs

    - name: Restore Cache prebuilts/build-tools
      id: prebuilts_build-tools
      uses: actions/cache@v3
      with:
        path: aosp/prebuilts/build-tools
        key: prebuilts_build-tools@${{ env.branch }}
        restore-keys: prebuilts_build-tools@${{ env.branch }}
    - name: Clone project prebuilts/build-tools
      if: steps.prebuilts_build-tools.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_sparse prebuilts/build-tools linux-x86/bin linux-x86/lib64 path common

    - name: Restore Cache prebuilts/clang-tools
      id: prebuilts_clang-tools
      uses: actions/cache@v3
      with:
        path: aosp/prebuilts/clang-tools
        key: prebuilts_clang-tools@${{ env.branch }}
        restore-keys: prebuilts_clang-tools@${{ env.branch }}
    - name: Clone project prebuilts/clang-tools
      if: steps.prebuilts_clang-tools.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_sparse prebuilts/clang-tools linux-x86/bin linux-x86/lib64/clang

    - name: Restore Cache prebuilts/clang/host/linux-x86
      id: prebuilts_clang_host_linux-x86
      uses: actions/cache@v3
      with:
        path: aosp/prebuilts/clang/host/linux-x86
        key: prebuilts_clang_host_linux-x86@${{ env.branch }}
        restore-keys: prebuilts_clang_host_linux-x86@${{ env.branch }}
    - name: Clone project prebuilts/clang/host/linux-x86
      if: steps.prebuilts_clang_host_linux-x86.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_sparse prebuilts/clang/host/linux-x86 $(python ${GITHUB_WORKSPACE}/get_clang_version.py) clang-r416183b soong

    - name: Restore Cache prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8
      id: prebuilts_gcc_linux-x86_host_x86_64-linux-glibc2_17-4_8
      uses: actions/cache@v3
      with:
        path: aosp/prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8
        key: prebuilts_gcc_linux-x86_host_x86_64-linux-glibc2_17-4_8@${{ env.branch }}
        restore-keys: prebuilts_gcc_linux-x86_host_x86_64-linux-glibc2_17-4_8@${{ env.branch }}
    - name: Clone project prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8
      if: steps.prebuilts_gcc_linux-x86_host_x86_64-linux-glibc2_17-4_8.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_sparse prebuilts/gcc/linux-x86/host/x86_64-linux-glibc2.17-4.8 sysroot lib/gcc/x86_64-linux/4.8.3 x86_64-linux/lib64 x86_64-linux/lib32

    - name: Restore Cache prebuilts/rust
      id: prebuilts_rust
      uses: actions/cache@v3
      with:
        path: aosp/prebuilts/rust
        key: prebuilts_rust@${{ env.branch }}
        restore-keys: prebuilts_rust@${{ env.branch }}
    - name: Clone project prebuilts/rust
      if: steps.prebuilts_rust.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_sparse prebuilts/rust bootstrap linux-x86/1.51.0

    - name: Restore Cache system/bt
      id: system_bt
      uses: actions/cache@v3
      with:
        path: aosp/system/bt
        key: system_bt@${{ env.branch }}
        restore-keys: system_bt@${{ env.branch }}
    - name: Clone project system/bt
      if: steps.system_bt.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform system/bt

    - name: Restore Cache system/core
      id: system_core
      uses: actions/cache@v3
      with:
        path: aosp/system/core
        key: system_core@${{ env.branch }}
        restore-keys: system_core@${{ env.branch }}
    - name: Clone project system/core
      if: steps.system_core.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform system/core

    - name: Restore Cache system/logging
      id: system_logging
      uses: actions/cache@v3
      with:
        path: aosp/system/logging
        key: system_logging@${{ env.branch }}
        restore-keys: system_logging@${{ env.branch }}
    - name: Clone project system/logging
      if: steps.system_logging.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform system/logging

    - name: Restore Cache system/sepolicy
      id: system_sepolicy
      uses: actions/cache@v3
      with:
        path: aosp/system/sepolicy
        key: system_sepolicy@${{ env.branch }}
        restore-keys: system_sepolicy@${{ env.branch }}
    - name: Clone project system/sepolicy
      if: steps.system_sepolicy.outputs.cache-hit != 'true'
      run: |
        cd aosp && source $GITHUB_WORKSPACE/envsetup.sh
        clone_depth_platform system/sepolicy

    - name: Start Soong
      run: |
        pushd aosp
        export TOP=$(pwd)
        cp build/make/core/root.mk Makefile
        ln -sf make/CleanSpec.mk build/ && ln -sf make/core build/
        ln -sf make/target build/ && ln -sf make/tools build/
        ln -sf build/soong/root.bp Android.bp
        mkdir -p prebuilts/jdk && touch prebuilts/jdk/.find-ignore
        mkdir -p prebuilts/jdk/jdk8 && mkdir -p prebuilts/jdk/jdk11
        ln -sf $JAVA_HOME_8_X64 prebuilts/jdk/jdk8/linux-x86
        ln -sf $JAVA_HOME_11_X64 prebuilts/jdk/jdk11/linux-x86
        mkdir -p prebuilts/go && touch prebuilts/go/.find-ignore
        ln -sf $GOROOT_1_19_X64 prebuilts/go/linux-x86
        mkdir -p out/soong/.minibootstrap out/soong/.bootstrap/bin
        ln -sf $GITHUB_WORKSPACE/soong_build out/soong/.bootstrap/bin
        ln -sf $GITHUB_WORKSPACE/bpglob out/soong/.minibootstrap
        cp $GITHUB_WORKSPACE/ckati prebuilts/build-tools/linux-x86/bin
        mkdir -p prebuiltlibs && cp $GITHUB_WORKSPACE/Android.bp prebuiltlibs/
        mkdir -p prebuiltlibs && cp $GITHUB_WORKSPACE/rust_prebuilt.list prebuiltlibs/
        echo "eng.buildbot.$(date '+%Y%m%d.%H%M%S')" > out/soong/build_number.txt
        mkdir -p external/compiler-rt/lib/cfi/ && curl 'https://android.googlesource.com/platform/external/compiler-rt/+/android12-gsi/lib/cfi/cfi_blocklist.txt?format=TEXT' | base64 -d > external/compiler-rt/lib/cfi/cfi_blocklist.txt
        $GITHUB_WORKSPACE/scripts/build0.sh
        df -h

    - name: Archive bionic-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: bionic-0.tar.xz
        path: aosp/bionic-0.tar.xz

    - name: Archive external_arm-optimized-routines-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_arm-optimized-routines-0.tar.xz
        path: aosp/external_arm-optimized-routines-0.tar.xz

    - name: Archive external_crosvm-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_crosvm-0.tar.xz
        path: aosp/external_crosvm-0.tar.xz

    - name: Archive external_gwp_asan-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_gwp_asan-0.tar.xz
        path: aosp/external_gwp_asan-0.tar.xz

    - name: Archive external_rust_crates_bytes-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_bytes-0.tar.xz
        path: aosp/external_rust_crates_bytes-0.tar.xz

    - name: Archive external_rust_crates_downcast-rs-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_downcast-rs-0.tar.xz
        path: aosp/external_rust_crates_downcast-rs-0.tar.xz

    - name: Archive external_rust_crates_either-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_either-0.tar.xz
        path: aosp/external_rust_crates_either-0.tar.xz

    - name: Archive external_rust_crates_fallible-iterator-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_fallible-iterator-0.tar.xz
        path: aosp/external_rust_crates_fallible-iterator-0.tar.xz

    - name: Archive external_rust_crates_fallible-streaming-iterator-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_fallible-streaming-iterator-0.tar.xz
        path: aosp/external_rust_crates_fallible-streaming-iterator-0.tar.xz

    - name: Archive external_rust_crates_glob-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_glob-0.tar.xz
        path: aosp/external_rust_crates_glob-0.tar.xz

    - name: Archive external_rust_crates_lazycell-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_lazycell-0.tar.xz
        path: aosp/external_rust_crates_lazycell-0.tar.xz

    - name: Archive external_rust_crates_paste-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_paste-0.tar.xz
        path: aosp/external_rust_crates_paste-0.tar.xz

    - name: Archive external_rust_crates_peeking_take_while-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_peeking_take_while-0.tar.xz
        path: aosp/external_rust_crates_peeking_take_while-0.tar.xz

    - name: Archive external_rust_crates_proc-macro-hack-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_proc-macro-hack-0.tar.xz
        path: aosp/external_rust_crates_proc-macro-hack-0.tar.xz

    - name: Archive external_rust_crates_regex-syntax-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_regex-syntax-0.tar.xz
        path: aosp/external_rust_crates_regex-syntax-0.tar.xz

    - name: Archive external_rust_crates_rustc-hash-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_rustc-hash-0.tar.xz
        path: aosp/external_rust_crates_rustc-hash-0.tar.xz

    - name: Archive external_rust_crates_scopeguard-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_scopeguard-0.tar.xz
        path: aosp/external_rust_crates_scopeguard-0.tar.xz

    - name: Archive external_rust_crates_shlex-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_shlex-0.tar.xz
        path: aosp/external_rust_crates_shlex-0.tar.xz

    - name: Archive external_rust_crates_termcolor-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_termcolor-0.tar.xz
        path: aosp/external_rust_crates_termcolor-0.tar.xz

    - name: Archive external_rust_crates_unicode-segmentation-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_unicode-segmentation-0.tar.xz
        path: aosp/external_rust_crates_unicode-segmentation-0.tar.xz

    - name: Archive external_rust_crates_unicode-width-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_unicode-width-0.tar.xz
        path: aosp/external_rust_crates_unicode-width-0.tar.xz

    - name: Archive external_rust_crates_unicode-xid-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_rust_crates_unicode-xid-0.tar.xz
        path: aosp/external_rust_crates_unicode-xid-0.tar.xz

    - name: Archive external_scudo-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: external_scudo-0.tar.xz
        path: aosp/external_scudo-0.tar.xz

    - name: Archive frameworks_rs-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: frameworks_rs-0.tar.xz
        path: aosp/frameworks_rs-0.tar.xz

    - name: Archive system_bt-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: system_bt-0.tar.xz
        path: aosp/system_bt-0.tar.xz

    - name: Archive system_core-0.tar.xz
      uses: actions/upload-artifact@v3
      with:
        name: system_core-0.tar.xz
        path: aosp/system_core-0.tar.xz

    - uses: softprops/action-gh-release@master
      with:
        name: ${{ env.branch }}-0
        tag_name: ${{ env.branch }}-0
        files: |
          aosp/bionic-0.tar.xz
          aosp/external_arm-optimized-routines-0.tar.xz
          aosp/external_crosvm-0.tar.xz
          aosp/external_gwp_asan-0.tar.xz
          aosp/external_rust_crates_bytes-0.tar.xz
          aosp/external_rust_crates_downcast-rs-0.tar.xz
          aosp/external_rust_crates_either-0.tar.xz
          aosp/external_rust_crates_fallible-iterator-0.tar.xz
          aosp/external_rust_crates_fallible-streaming-iterator-0.tar.xz
          aosp/external_rust_crates_glob-0.tar.xz
          aosp/external_rust_crates_lazycell-0.tar.xz
          aosp/external_rust_crates_paste-0.tar.xz
          aosp/external_rust_crates_peeking_take_while-0.tar.xz
          aosp/external_rust_crates_proc-macro-hack-0.tar.xz
          aosp/external_rust_crates_regex-syntax-0.tar.xz
          aosp/external_rust_crates_rustc-hash-0.tar.xz
          aosp/external_rust_crates_scopeguard-0.tar.xz
          aosp/external_rust_crates_shlex-0.tar.xz
          aosp/external_rust_crates_termcolor-0.tar.xz
          aosp/external_rust_crates_unicode-segmentation-0.tar.xz
          aosp/external_rust_crates_unicode-width-0.tar.xz
          aosp/external_rust_crates_unicode-xid-0.tar.xz
          aosp/external_scudo-0.tar.xz
          aosp/frameworks_rs-0.tar.xz
          aosp/system_bt-0.tar.xz
          aosp/system_core-0.tar.xz

    - name: Restore Cache bionic-0.tar.xz
      id: bionic-0
      uses: actions/cache@v3
      with:
        path: aosp/bionic-0.tar.xz
        key: bionic-0
        restore-keys: bionic-0

    - name: Restore Cache external_arm-optimized-routines-0.tar.xz
      id: external_arm-optimized-routines-0
      uses: actions/cache@v3
      with:
        path: aosp/external_arm-optimized-routines-0.tar.xz
        key: external_arm-optimized-routines-0
        restore-keys: external_arm-optimized-routines-0

    - name: Restore Cache external_crosvm-0.tar.xz
      id: external_crosvm-0
      uses: actions/cache@v3
      with:
        path: aosp/external_crosvm-0.tar.xz
        key: external_crosvm-0
        restore-keys: external_crosvm-0

    - name: Restore Cache external_gwp_asan-0.tar.xz
      id: external_gwp_asan-0
      uses: actions/cache@v3
      with:
        path: aosp/external_gwp_asan-0.tar.xz
        key: external_gwp_asan-0
        restore-keys: external_gwp_asan-0

    - name: Restore Cache external_rust_crates_bytes-0.tar.xz
      id: external_rust_crates_bytes-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_bytes-0.tar.xz
        key: external_rust_crates_bytes-0
        restore-keys: external_rust_crates_bytes-0

    - name: Restore Cache external_rust_crates_downcast-rs-0.tar.xz
      id: external_rust_crates_downcast-rs-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_downcast-rs-0.tar.xz
        key: external_rust_crates_downcast-rs-0
        restore-keys: external_rust_crates_downcast-rs-0

    - name: Restore Cache external_rust_crates_either-0.tar.xz
      id: external_rust_crates_either-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_either-0.tar.xz
        key: external_rust_crates_either-0
        restore-keys: external_rust_crates_either-0

    - name: Restore Cache external_rust_crates_fallible-iterator-0.tar.xz
      id: external_rust_crates_fallible-iterator-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_fallible-iterator-0.tar.xz
        key: external_rust_crates_fallible-iterator-0
        restore-keys: external_rust_crates_fallible-iterator-0

    - name: Restore Cache external_rust_crates_fallible-streaming-iterator-0.tar.xz
      id: external_rust_crates_fallible-streaming-iterator-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_fallible-streaming-iterator-0.tar.xz
        key: external_rust_crates_fallible-streaming-iterator-0
        restore-keys: external_rust_crates_fallible-streaming-iterator-0

    - name: Restore Cache external_rust_crates_glob-0.tar.xz
      id: external_rust_crates_glob-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_glob-0.tar.xz
        key: external_rust_crates_glob-0
        restore-keys: external_rust_crates_glob-0

    - name: Restore Cache external_rust_crates_lazycell-0.tar.xz
      id: external_rust_crates_lazycell-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_lazycell-0.tar.xz
        key: external_rust_crates_lazycell-0
        restore-keys: external_rust_crates_lazycell-0

    - name: Restore Cache external_rust_crates_paste-0.tar.xz
      id: external_rust_crates_paste-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_paste-0.tar.xz
        key: external_rust_crates_paste-0
        restore-keys: external_rust_crates_paste-0

    - name: Restore Cache external_rust_crates_peeking_take_while-0.tar.xz
      id: external_rust_crates_peeking_take_while-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_peeking_take_while-0.tar.xz
        key: external_rust_crates_peeking_take_while-0
        restore-keys: external_rust_crates_peeking_take_while-0

    - name: Restore Cache external_rust_crates_proc-macro-hack-0.tar.xz
      id: external_rust_crates_proc-macro-hack-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_proc-macro-hack-0.tar.xz
        key: external_rust_crates_proc-macro-hack-0
        restore-keys: external_rust_crates_proc-macro-hack-0

    - name: Restore Cache external_rust_crates_regex-syntax-0.tar.xz
      id: external_rust_crates_regex-syntax-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_regex-syntax-0.tar.xz
        key: external_rust_crates_regex-syntax-0
        restore-keys: external_rust_crates_regex-syntax-0

    - name: Restore Cache external_rust_crates_rustc-hash-0.tar.xz
      id: external_rust_crates_rustc-hash-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_rustc-hash-0.tar.xz
        key: external_rust_crates_rustc-hash-0
        restore-keys: external_rust_crates_rustc-hash-0

    - name: Restore Cache external_rust_crates_scopeguard-0.tar.xz
      id: external_rust_crates_scopeguard-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_scopeguard-0.tar.xz
        key: external_rust_crates_scopeguard-0
        restore-keys: external_rust_crates_scopeguard-0

    - name: Restore Cache external_rust_crates_shlex-0.tar.xz
      id: external_rust_crates_shlex-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_shlex-0.tar.xz
        key: external_rust_crates_shlex-0
        restore-keys: external_rust_crates_shlex-0

    - name: Restore Cache external_rust_crates_termcolor-0.tar.xz
      id: external_rust_crates_termcolor-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_termcolor-0.tar.xz
        key: external_rust_crates_termcolor-0
        restore-keys: external_rust_crates_termcolor-0

    - name: Restore Cache external_rust_crates_unicode-segmentation-0.tar.xz
      id: external_rust_crates_unicode-segmentation-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_unicode-segmentation-0.tar.xz
        key: external_rust_crates_unicode-segmentation-0
        restore-keys: external_rust_crates_unicode-segmentation-0

    - name: Restore Cache external_rust_crates_unicode-width-0.tar.xz
      id: external_rust_crates_unicode-width-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_unicode-width-0.tar.xz
        key: external_rust_crates_unicode-width-0
        restore-keys: external_rust_crates_unicode-width-0

    - name: Restore Cache external_rust_crates_unicode-xid-0.tar.xz
      id: external_rust_crates_unicode-xid-0
      uses: actions/cache@v3
      with:
        path: aosp/external_rust_crates_unicode-xid-0.tar.xz
        key: external_rust_crates_unicode-xid-0
        restore-keys: external_rust_crates_unicode-xid-0

    - name: Restore Cache external_scudo-0.tar.xz
      id: external_scudo-0
      uses: actions/cache@v3
      with:
        path: aosp/external_scudo-0.tar.xz
        key: external_scudo-0
        restore-keys: external_scudo-0

    - name: Restore Cache frameworks_rs-0.tar.xz
      id: frameworks_rs-0
      uses: actions/cache@v3
      with:
        path: aosp/frameworks_rs-0.tar.xz
        key: frameworks_rs-0
        restore-keys: frameworks_rs-0

    - name: Restore Cache system_bt-0.tar.xz
      id: system_bt-0
      uses: actions/cache@v3
      with:
        path: aosp/system_bt-0.tar.xz
        key: system_bt-0
        restore-keys: system_bt-0

    - name: Restore Cache system_core-0.tar.xz
      id: system_core-0
      uses: actions/cache@v3
      with:
        path: aosp/system_core-0.tar.xz
        key: system_core-0
        restore-keys: system_core-0